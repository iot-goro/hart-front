<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>WebSocket</title>
</head>

<body>
    <div id="showqr"></div>
    <p id="output"></p>
    
    <script src="../scripts/qrcode.min.js"></script>
    <script>
        // uuid を生成する
        let wsid = crypto.randomUUID();

        // uuid が保存されていない場合
        if (!localStorage.getItem('wsid')) {
            localStorage.setItem('wsid', wsid);
        }

        // uuid を取得する
        wsid = localStorage.getItem('wsid');

        var qrcode = new QRCode("showqr", {
            text: wsid,
            width: 500,
            height: 500,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        function ConnectWs() {
            let ws = new WebSocket("wss://iot-hart.mattuu.com/app/ws")

            ws.onopen = function () {
                console.log('Connected');

                // 接続IDを送る
                ws.send(wsid);
            }

            ws.onmessage = function (evt) {
                var out = document.getElementById('output');
                out.innerHTML += evt.data + '<br>';
            };

            ws.onclose = function () {
                console.log('Disconnected');
                // 再接続
                setTimeout(() => {
                    ConnectWs();
                }, 3000);
            };
        };

        ConnectWs();
    </script>

    

</body>

</html>